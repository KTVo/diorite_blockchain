<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Diorite</title>

    <link rel="stylesheet" type="text/css" href="css/main.css" />

    <!-- <script src="js/require.js"></script> -->
	
	<script src="js/app.js"></script>
    <script src="js/web3.min.js"></script>

	
  </head>

  <body>
    <div class="container">
      <h1>Diorite</h1>

      <label for="name" class="col-lg-2 control-label"><h3>Diorite Wallet</h3></label>
	  <hr />
      <input id="NodeInfo" type="text" STYLE="margin-top: 8px"/>

      <label for="name" class="col-lg-2 control-label"><h3>Node Info</h3></label>
      <p>Account: <input id="Account" type="text" STYLE="background-color: #CCCCCC;" readonly/></p>
      <p>Balance: <input id="Balance" type="text" STYLE="background-color: #CCCCCC;" readonly/></p>
      <button id="checkBalance">Check Balance</button>

      <hr />
      <label for="name" class="col-lg-2 control-label"><h3>Trading Diorite</h3></label>
      <p>From: &nbsp &nbsp &nbsp <input id="From" type="text" STYLE="background-color: #CCCCCC;" readonly/></p>
      <p>To: &nbsp &nbsp &nbsp &nbsp &nbsp <input id="To" type="text" /></p>
      <p>Amount: &nbsp <input id="Amount" type="text" /></p>
      <button id="Transfer">Transfer</button>
      <p>Transaction Hash: &nbsp <span id="Tx"></span></p>
	  
	   <hr />
      <label for="name" class="col-lg-2 control-label"><h3>Buy Diorite</h3></label>
      <p>From: &nbsp &nbsp &nbsp <input id="FromBuyDiorite" type="text" STYLE="background-color: #CCCCCC;" readonly/></p>
      <p>Amount: &nbsp <input id="AmountBuyDiorite" type="text" /></p>
      <button id="TransferBuyDiorite">Purchase Diorite</button>
      <p>Transaction Hash: &nbsp <span id="TxBuyDiorite"></span></p>
    </div>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>

    <script>
      $(document).ready(function () {
        console.log("ready!");

        if (typeof web3 !== "undefined") {
          web3 = new Web3(web3.currentProvider);
        } else {
          // set the provider you want from Web3.providers
          web3 = new Web3(
            new Web3.providers.HttpProvider("http://127.0.0.1:7545")
          );
        }

        web3 = new Web3(
          new Web3.providers.HttpProvider("http://127.0.0.1:7545")
        );
		
		var contract;
		
		var contractAddress = "0x5FA8D0a51acBE537784911947f8c7aC5D01a3288";
		var contractABI = [
    {
      "inputs": [],
      "payable": false,
      "stateMutability": "nonpayable",
      "type": "constructor"
    },
    {
      "constant": true,
      "inputs": [
        {
          "internalType": "string",
          "name": "",
          "type": "string"
        }
      ],
      "name": "users",
      "outputs": [
        {
          "internalType": "string",
          "name": "addr",
          "type": "string"
        },
        {
          "internalType": "uint256",
          "name": "dioriteBalance",
          "type": "uint256"
        },
        {
          "internalType": "bool",
          "name": "isValue",
          "type": "bool"
        }
      ],
      "payable": false,
      "stateMutability": "view",
      "type": "function"
    },
    {
      "constant": false,
      "inputs": [
        {
          "internalType": "string",
          "name": "_senderAddr",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "_receiverAddr",
          "type": "string"
        },
        {
          "internalType": "uint256",
          "name": "_etherAmt",
          "type": "uint256"
        }
      ],
      "name": "send",
      "outputs": [],
      "payable": false,
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "constant": false,
      "inputs": [
        {
          "internalType": "string",
          "name": "_accountAddr",
          "type": "string"
        },
        {
          "internalType": "uint256",
          "name": "_etherAmt",
          "type": "uint256"
        }
      ],
      "name": "buy",
      "outputs": [],
      "payable": false,
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "constant": false,
      "inputs": [
        {
          "internalType": "string",
          "name": "_accountAddr",
          "type": "string"
        }
      ],
      "name": "getBalance",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "payable": false,
      "stateMutability": "nonpayable",
      "type": "function"
    }
  ];
			  
		contract = new web3.eth.Contract(contractABI, contractAddress);
		
		
		

        /* Get Node Info */
        web3.eth.getNodeInfo(function (error, result) {
          if (error) {
            console.log("error", error);
          } else {
            console.log("result", result);
            $("#NodeInfo").val(result);
          }
        });

        /* Get Balance */
        web3.eth.getAccounts(function (error, accounts) {
		
		  console.log("ACCOUNTSSSSS = " + accounts);
		  
          if (error) {
            console.log(error);
          }
          $("#Account").val(accounts[0]);
          web3.eth.getBalance(accounts[0]).then(function (result) {
		  
		  var rounded_balanaced = Math.round(web3.utils.fromWei(result, "ether"));
            console.log("Balance : ", rounded_balanaced);
            $("#Balance").val(rounded_balanaced);
          });
		  
		  // Populating "From:" from "Trading Diorite" section
		  $("#From").val(accounts[0]);
		  
		  // Populating "From:" from "Buy Diorite" section
		  $("#FromBuyDiorite").val(accounts[0]);

        });

        $("#checkBalance").click(function () {
          var _account = $("#Account").val();
          web3.eth.getBalance(_account).then(function (result) {
            console.log("Balance: ", web3.utils.fromWei(result, "ether"));
            $("#Balance").val(web3.utils.fromWei(result, "ether"));
          });
		  
        });

        /* Send Diorite to other person */
		// For giving away diorite to another person
        $("#Transfer").click(function () {
          $("#Tx").text("");
          var _from = $("#From").val();
          var _to = $("#To").val();
          var _Amount = $("#Amount").val();
          var txnObject = {
            from: _from,
            to: _to,
            value: web3.utils.toWei(_Amount, "ether"),
            // "gas": 21000,         (optional)
            // "gasPrice": 4500000,  (optional)
            // "data": 'For testing' (optional)
            // "nonce": 10           (optional)
          };

          web3.eth.sendTransaction(txnObject, function (error, result) {
            if (error) {
              console.log("Transaction error", error);
            } else {
              var txn_hash = result; //Get transaction hash
              $("#Tx").text(txn_hash);
            }
          });
		  
        });
		
		/* Send to Master account */
		// To pay Master account for diorite
        $("#TransferBuyDiorite").click(function () {
          $("#TxBuyDiorite").text("");
          var _from = $("#FromBuyDiorite").val();
          const _to = "0xb0630dc4c80A85f0aDB0E8e9857Ac6E208589Ddb";
          var _Amount = $("#AmountBuyDiorite").val();
		  
          var txnObject = {
            from: _from,
            to: _to,
            value: web3.utils.toWei(_Amount, "ether"),
            // "gas": 21000,         (optional)
            // "gasPrice": 4500000,  (optional)
            // "data": 'For testing' (optional)
            // "nonce": 10           (optional)
          };

          web3.eth.sendTransaction(txnObject, function (error, result) {
            if (error) {
              console.log("Transaction error", error);
            } else {
              var txn_hash = result; //Get transaction hash
              $("#TxBuyDiorite").text(txn_hash);
			  
			    //Parameters:
				// _from -> the recipient/buyer of Diorite
				// _Amount -> how much Diorite is being purchased
				contract.methods.buy("0x56c339DE2092b89D8bca6ce7B67928E511740821", _Amount).call().then().catch( function(err) { 
						console.log(err); 
					});
				
				
            }
          });
		  
        });
		
        
      });

      
    </script>
  </body>
</html>